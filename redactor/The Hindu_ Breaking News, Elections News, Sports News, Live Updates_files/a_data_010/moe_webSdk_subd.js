function registerServieWorker(){return new Promise(function(a,b){"serviceWorker"in navigator?navigator.serviceWorker.register("serviceworker.js",{scope:"./"}).then(function(){a()},function(a){b()}):(console.log("Servie Worker Not Supported"),b())})}function forceOptIn(){"default"==Notification.permission?(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_SHOWN"},"*"),Notification.requestPermission(function(a){"default"==a?(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_DISMISSED"},"*"),forceOptIn()):processOptIn(a)})):processOptIn(Notification.permission)}function processOptIn(a){var b=new CustomEvent("MOE_OPTIN_UPDATE",{detail:a}),c=new CustomEvent("MOE_OPTIN_UPDATE_COMPLETE",{detail:a});window.dispatchEvent(b),"granted"==a?(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_ALLOWED"},"*"),updatePushToken().then(function(){window.opener&&window.opener.postMessage({type:"MOE_CONVENTIONAL_OPT_IN"},"*"),window.dispatchEvent(c)})):"denied"==a&&(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_BLOCKED"},"*"),window.dispatchEvent(c))}function refreshTokenByPopup(){var a=localStorage.getItem("MOE_OPENED_ONCE_SETUP"),b=new Date,c=b.getTime()-864e5*moePopupRefreshInterval;a&&parseInt(a)<c&&localStorage.removeItem("MOE_OPENED_ONCE"),a||"yes"!=localStorage.getItem("MOE_OPENED_ONCE")||localStorage.setItem("MOE_OPENED_ONCE_SETUP",b.getTime())}function updatePushToken(){if("granted"==Notification.permission&&self===top)return registerServieWorker().then(function(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.subscribe({userVisibleOnly:!0})}).then(function(a){var b=a.endpoint.split("/"),c=b[b.length-1];localStorage.setItem("moe_push_storage",c),dataToServiceWorker=JSON.parse(localStorage.getItem("moengage_collected_data")),dataToServiceWorker.push_id=c;try{navigator.serviceWorker.controller.postMessage({data:dataToServiceWorker})}catch(a){console.log("data not sent to serviceWorker")}})})}var moeSubscribeUserSwap,moeUnSubscribeUserSwap,moeCheckPushSubscriptionStatus,moeLoadBanner,moeRemoveBanner,moeOpenSubDomain,moeCloseBanner,moePopupRefreshInterval=30,createObjFromURI=function(){for(var a=decodeURI(location.search.substr(1)),b=a.split("&"),c=Object(),d=0;d<b.length;d++){var e=b[d].split("=");e[0].search("\\[\\]")!==-1?"undefined"==typeof c[e[0]]?c[e[0]]=[e[1]]:c[e[0]].push(e[1]):c[e[0]]=e[1]}return c},dataToServiceWorker=createObjFromURI();void 0==dataToServiceWorker[""]&&delete dataToServiceWorker[""];var baseDomainName="https://websdk.moengage.com",debug_mode=0,initialize=0,sdk_version="3.0",userStructure={user_attr:{},event_queue:[],user_attr_queue:[],device_add:!1};Notification||(Notification={permission:"denied",requestPermission:function(){return"denied"}});var listener=function(a){if("get_push_token"==a.data)token=localStorage.getItem("moe_push_storage"),dataToSend={type:"get_push_token",token:token},a.source.postMessage(dataToSend,a.origin);else if("opened_once"==a.data)token=localStorage.getItem("MOE_OPENED_ONCE"),dataToSend={type:"opened_once",token:token},a.source.postMessage(dataToSend,a.origin);else if("ask_for_notification"==a.data)Notification.requestPermission(function(b){return"denied"===b?(token="DENY",dataToSend={type:"ask_for_notification",token:token},localStorage.setItem("MOE_ACCEPTED","DENY"),a.source.postMessage(dataToSend,a.origin),void console.log("Permission wasn't granted. Allow a retry.")):"default"===b?(token="PROMPT",dataToSend={type:"ask_for_notification",token:token},localStorage.setItem("MOE_ACCEPTED","PROMPT"),a.source.postMessage(dataToSend,a.origin),void console.log("The permission request was dismissed.")):(token="ACCEPT",dataToSend={type:"ask_for_notification",token:token},localStorage.setItem("MOE_ACCEPTED","ACCEPT"),void a.source.postMessage(dataToSend,a.origin))});else if("is_already_accepted"==a.data)"default"==Notification.permission?token="prompt":"denied"==Notification.permission?token="denied":token="granted",dataToSend={type:"is_already_accepted",token:token},a.source.postMessage(dataToSend,a.origin);else if("moengage_data_from_frame"==a.data){token=localStorage.getItem("moengage_data_subdomain");var b=localStorage.getItem("moe_push_storage");dataToSend={type:"moengage_data_from_frame",token:token,push:b},a.source.postMessage(dataToSend,a.origin)}else if("destroy_session"==a.data)destroySession(),token="destroy_session_subdomain",dataToSend={type:"destroy_session",token:token},a.source.postMessage(dataToSend,a.origin);else if(a.data&&"moengage_data_to_frame"==a.data.type){temp=a.data.token,temp2=a.data.collect_data,temp2&&localStorage.setItem("moengage_collected_data",JSON.stringify(temp2)),localStorage.setItem("moengage_data_subdomain",JSON.stringify(temp));try{var c=a.data.collect_data;c&&c.unique_id&&c.app_id}catch(a){}}},destroySession=function(){localStorage.removeItem("moeWebSDKSettings"),localStorage.removeItem("MOE_ACCEPTED"),localStorage.removeItem("moeWebSDKSettingsSetupTime"),localStorage.removeItem("moengage_data"),localStorage.removeItem("moe_push_storage"),localStorage.removeItem("moengage_data_subdomain"),localStorage.removeItem("moe-ftl"),localStorage.removeItem("MOE_PUSH_TOKEN"),localStorage.removeItem("ask_web_push"),localStorage.removeItem("MOE_LAST_PROMPT"),localStorage.removeItem("MOE_OPENED_ONCE"),localStorage.removeItem("SOFT_LOAD")},resetToken=function(){"denied"!=Notification.permission&&"default"!=Notification.permission||localStorage.removeItem("moe_push_storage")};resetToken();var guid=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return debug_mode&&console.log("Generating new unique_id"),a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},first_event_queue=0,first_user_attr_queue=0,clearQueue_counter=0,retry_limit=5,subscriptionId,isIncognitoFlag,sBrowser,sUsrAg=navigator.userAgent;navigator.userAgent.indexOf("MSIE")!=-1||1==!!document.documentMode?(sBrowser="Internet Explorer",console.log("Browser not supported.")):sUsrAg.indexOf("Edge")>-1?sBrowser="Edge":sUsrAg.indexOf("OPR")>-1||sUsrAg.indexOf("Opera")>-1?sBrowser="Opera":sUsrAg.indexOf("Chrome")>-1?(sBrowser="Google Chrome",sUsrAg.indexOf("MMS")>-1&&(sBrowser="Opera Neon")):sBrowser=sUsrAg.indexOf("Safari")>-1?"Apple Safari":sUsrAg.indexOf("Firefox")>-1?"Mozilla Firefox":"Others";var makePost=function(a,b,c,d){var e=new XMLHttpRequest;a=constructGet(a,b),e.open("POST",a,!0),e.onreadystatechange=function(){4==e.readyState&&d&&d(e.responseText,e.status)},e.send(JSON.stringify(c))},constructGet=function(a,b){a+="?";for(var c in b)a+=c+"="+b[c]+"&";return a},set_item=function(a){try{window.location.search.replace("?","");localStorage.setItem("moengage_data",JSON.stringify(a))}catch(a){debug_mode&&console.log("Cannot set Item",a)}},track_event=function(a,b,c){},add_user_attribute=function(a,b,c){},collectData=function(){var a=new Date;Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds());return promise=new Promise(function(a){get_params=dataToServiceWorker,subscriptionId?get_params.push_id=subscriptionId:get_params.push_id="NA",a(get_params)}),promise},webPushFunctions=function(a){var b=!0,c=function(a,b){return new Promise(function(c,d){if(dataToServiceWorker.unique_id){var e=localStorage.getItem("moe_push_storage");if(!a){subscriptionId=null,"unsubscribed"==b?track_event("MOE_USER_UNSUBSCRIBED",{MOE_WEB_PUSH_TOKEN:"NA"}):void 0==b&&"null"!=e&&track_event("MOE_USER_SUBSCRIPTION_CHECK",{MOE_WEB_PUSH_TOKEN:"NA"}),localStorage.setItem("moe_push_storage",null),dataToServiceWorker.push_id=subscriptionId;try{navigator.serviceWorker.controller.postMessage({data:dataToServiceWorker})}catch(a){console.log("data not sent to serviceWorker (null scenario)")}return void c()}endpointSections=a.endpoint.split("/"),subscriptionId=endpointSections[endpointSections.length-1],dataToServiceWorker.push_id=subscriptionId,"subscribed"==b?(add_user_attribute("Web Push Preference","granted"),localStorage.setItem("moe_push_storage",subscriptionId),track_event("MOE_USER_SUBSCRIBED",{MOE_WEB_PUSH_TOKEN:subscriptionId},"hide")):void 0==b&&e!=subscriptionId&&(add_user_attribute("Web Push Preference","granted"),track_event("MOE_USER_SUBSCRIPTION_CHECK",{MOE_WEB_PUSH_TOKEN:subscriptionId}),localStorage.setItem("moe_push_storage",subscriptionId));try{navigator.serviceWorker.controller.postMessage({data:dataToServiceWorker})}catch(a){console.log("data not sent to serviceWorker")}c()}else d("Unique ID null")})},d=function(){return new Promise(function(a,b){navigator.serviceWorker.ready.then(function(a){return a.pushManager.subscribe({userVisibleOnly:!0})}).then(function(d){c(d,"subscribed").then(function(){a()},function(a){b(a)})}).catch(function(a){return b("Subscription Failed"),"Subscription Failed"})})},e=function(){"serviceWorker"in navigator&&("Google Chrome"==sBrowser||"Mozilla Firefox"==sBrowser||"Opera"==sBrowser||"Opera Neon"==sBrowser)&&navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){var b=document.getElementById("subscribing");return b||console.log("subscribing span missing"),a?void c(a).then(function(){setTimeout(function(){window.opener&&window.opener.postMessage({type:"subscription_timeout"},"*"),window.close()},1e4),b&&(b.innerHTML="Subscribed!!"),setTimeout(function(){window.close()},500)},function(a){b&&(b.innerHTML="Unsuccessful!!"),setTimeout(function(){window.opener&&window.opener.postMessage({type:"MOE_NEVER_ASK"},"*"),window.close()},5e3),console.log(a)}):void c(null).then(function(){setTimeout(function(){window.opener&&window.opener.postMessage({type:"subscription_timeout"},"*"),window.close()},1e4),d().then(function(){b&&(b.innerHTML="Subscribed!!"),setTimeout(function(){window.close()},500)},function(a){b&&(b.innerHTML="Unsuccessful!!"),setTimeout(function(){},500),console.log(a)})})}).catch(function(a){})};1==b&&registerServieWorker().then(e)};window.addEventListener("message",listener,!1);var gets=window.location.search.replace("?","");if(gets.length>0){localStorage.setItem("MOE_OPENED_ONCE","yes");var a=new Date;localStorage.setItem("MOE_OPENED_ONCE_SETUP",a.getTime()),gets.indexOf("conventional")>-1?(localStorage.setItem("MOE_CONVENTIONAL_OPT_IN","true"),forceOptIn()):webPushFunctions()}updatePushToken();